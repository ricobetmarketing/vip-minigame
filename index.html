<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>VIP Missions â€” Gated Landing</title>
<meta name="theme-color" content="#121125" />
<style>
  :root{
    --bg:#0f1129; --card:#121125; --ring:#2a2e58;
    --ink:#f2f3ff; --mut:#c7cbff;
    --g1:#ff6ec4; --g2:#7873f5;
    --ok:#aef7c1; --bad:#ffb3be; --gold:#ffd86a;
    --glow: 0 0 24px rgba(120,115,245,.55), 0 0 48px rgba(255,110,196,.35);
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0;color:var(--ink);
    font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Arial;
    background:
      radial-gradient(1100px 700px at 70% -10%, #1a1c3a 0%, #0f1129 60%, #0a0b1e 100%),
      conic-gradient(from 180deg at 10% -20%, rgba(120,115,245,.12), transparent 30%);
  }
  .wrap{max-width:1100px;margin:0 auto;padding:18px}
  .hdr{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:14px}
  .logo{font-weight:900;letter-spacing:.3px;font-size:20px;background:linear-gradient(90deg,var(--g1),var(--g2));-webkit-background-clip:text;background-clip:text;color:transparent;filter:drop-shadow(0 4px 18px rgba(255,110,196,.18))}
  .chip{padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid var(--ring);color:var(--mut);display:inline-flex;gap:6px;align-items:center;background:#16173a}
  .chip.ok{border-color:#285a3a;color:#b7ffcc;background:#11251a}
  .chip.bad{border-color:#5a2831;color:#ffd0d6;background:#2a0f16}
  .btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:800;color:#0a0b1e;background:linear-gradient(90deg,var(--g1),var(--g2));cursor:pointer;box-shadow:var(--glow)}
  .btn.secondary{background:#1a1d46;color:var(--ink);border:1px solid var(--ring);box-shadow:none}
  .btn.ghost{background:transparent;color:var(--mut);border:1px dashed var(--ring);box-shadow:none}
  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}
  .card{background:linear-gradient(180deg,#14133a 0%,#11102c 50%,#0f1027 100%);border:1px solid #232656;border-radius:16px;padding:16px;box-shadow:0 18px 50px rgba(0,0,0,.45)}
  .card h3{margin:0 0 10px 0;font-size:16px}
  .mut{color:var(--mut);font-size:12px}
  .divider{height:1px;background:linear-gradient(90deg,transparent,#2a2e58 30%,#2a2e58 70%,transparent);margin:12px 0}
  input[type="text"]{width:100%;background:#0f1129;border:1px solid var(--ring);border-radius:10px;color:#var(--ink);padding:10px 12px;outline:none}

  /* Gate modal */
  .mask{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.7);z-index:50}
  .modal{background:#0f1129;border:1px solid #2a2e58;border-radius:16px;padding:18px;width:min(92%,520px)}
  .row{display:flex;gap:8px;align-items:center;margin:8px 0}
  .err{color:#ffb3be;font-size:12px}

  /* Header profile chip */
  .profileChip{display:flex;align-items:center;gap:8px;background:#17173a;border:1px solid var(--ring);padding:6px 10px;border-radius:999px;cursor:pointer}
  .profileChip img{width:24px;height:24px;border-radius:50%}

  /* Avatar picker */
  .mask.sm{align-items:flex-end;padding:12px}
  .sheet{background:#0f1129;border:1px solid #2a2e58;border-radius:16px 16px 0 0;padding:14px;width:100%;max-width:680px;margin:0 auto}
  .gridAva{display:grid;grid-template-columns:repeat(6,1fr);gap:10px}
  .gridAva img{width:100%;aspect-ratio:1/1;border-radius:10px;border:1px solid #2a2e58;cursor:pointer}
  @media (max-width:680px){.gridAva{grid-template-columns:repeat(4,1fr)}}

  /* Meter */
  .meter{height:16px;border-radius:999px;background:#16173a;border:1px solid var(--ring);position:relative;overflow:hidden}
  .fill{position:absolute;left:0;top:0;bottom:0;width:0;background:linear-gradient(90deg,#41e2ff,#7f77ff,#ff6ec4);transition:width .4s ease}
  .tiers{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .tier{flex:1;min-width:120px;background:#16173a;border:1px solid var(--ring);border-radius:12px;padding:8px}
  .tier h4{margin:0 0 2px 0;font-size:12px}
  .tier p{margin:0;font-size:11px;color:var(--mut)}

  /* Game */
  .gameWrap{background:#0c0e26;border:1px solid #273064;border-radius:16px;padding:12px;position:relative;overflow:hidden}
  .gameTop{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:8px}
  canvas{width:100%;height:360px;background:radial-gradient(600px 300px at 50% -100px,#1d2255,#0c0e26 50%);border-radius:12px;display:block;box-shadow:0 8px 40px rgba(127,119,255,.15)}
  .spark{position:absolute;pointer-events:none;filter:drop-shadow(0 0 8px rgba(255,255,255,.6))}

  /* Leaderboard */
  .lb table{width:100%;border-collapse:collapse}
  .lb th,.lb td{padding:8px;border-bottom:1px solid #2a2e58;font-size:12px}
  .lb th{color:#a4b0ff;text-align:left}
  .pos{width:40px;color:var(--gold);font-weight:800}
  .me{background:linear-gradient(90deg, rgba(120,115,245,.08), transparent); border-left:3px solid #7873f5}

  /* Sync chip */
  .sync{font-size:11px;color:#a4b0ff}
</style>
</head>
<body>

<!-- ===== Gate: must enter allowlisted username ===== -->
<div class="mask" id="gateMask">
  <div class="modal">
    <h3>Enter your username to continue</h3>
    <div class="mut">Access is only available to approved usernames. (Case-insensitive)</div>
    <div class="row">
      <input id="gateUsername" type="text" placeholder="Your username" maxlength="40" />
      <button class="btn" id="gateEnterBtn">Enter</button>
    </div>
    <div class="err" id="gateErr" style="display:none"></div>
    <div class="divider"></div>
    <div class="mut" id="gateTips">Tip: Your name is checked against the VIP Allowlist.</div>
  </div>
</div>

<!-- ===== Avatar picker sheet ===== -->
<div class="mask sm" id="avatarMask" style="display:none">
  <div class="sheet">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
      <h3 style="margin:0">Choose your avatar</h3>
      <button class="btn secondary" id="closeAvaBtn">Close</button>
    </div>
    <div class="gridAva" id="avaGrid"></div>
    <div class="mut" style="margin-top:8px">Tip: click an image to select. Changes save instantly.</div>
  </div>
</div>

<div class="wrap" id="app" style="display:none">
  <div class="hdr">
    <div>
      <div class="logo">VIP Missions</div>
      <div class="sync" id="syncChip" style="display:none">Syncingâ€¦</div>
    </div>
    <div class="profileChip" id="profileChip" title="Click to change avatar">
      <img id="avatarImg" alt="" />
      <span id="topUsername">â€”</span>
      <span id="verifyChip" class="chip">Checkingâ€¦</span>
    </div>
  </div>

  <div class="grid">
    <!-- LEFT -->
    <div class="card">
      <h3>Missions (earn points â†’ boost VIP Day)</h3>
      <div class="row"><span id="m_verified" class="chip">Verified Username +1 (once)</span></div>
      <div class="row"><span id="m_checkin" class="chip">Daily Check-in (1â€“14 only) +1/day</span> <button class="btn secondary" id="checkinBtn">Check in</button></div>
      <div class="row"><span id="m_game" class="chip">Mini-game: 20+=+1, 50+=+2, 100+=+3 (max +3/day)</span></div>
      <div class="divider"></div>

      <h3>Mini-game: Catch the Coin</h3>
      <div class="gameWrap" id="gameWrap">
        <div class="gameTop">
          <div class="mut">Score: <b id="scoreTxt">0</b> â€¢ Best: <b id="bestTxt">0</b></div>
          <div style="display:flex;gap:8px;align-items:center">
            <label class="mut"><input id="soundChk" type="checkbox"> Sound</label>
            <button class="btn" id="startBtn">Start</button>
            <button class="btn secondary" id="backBtn" disabled>Back</button>
          </div>
        </div>
        <canvas id="game" width="640" height="360"></canvas>
        <div class="mut">Move paddle with finger/mouse. Catch ðŸª™, avoid ðŸ’£, grab âœ¨ x2 multiplier.</div>
      </div>
    </div>

    <!-- RIGHT -->
    <div>
      <div class="card">
        <h3>Your VIP Day Boost</h3>
        <div class="row" style="justify-content:space-between">
          <div>Total Points: <b id="ptsTotal">0</b></div>
          <div class="mut">Game credit today: <b id="dailyCredit">0/3</b></div>
        </div>
        <div class="meter"><div class="fill" id="fill"></div></div>
        <div class="tiers">
          <div class="tier"><h4>Tier 0 â€¢ 0â€“4</h4><p>Base reward</p></div>
          <div class="tier"><h4>Tier 1 â€¢ 5â€“9</h4><p>Small boost</p></div>
          <div class="tier"><h4>Tier 2 â€¢ 10â€“19</h4><p>Medium boost</p></div>
          <div class="tier"><h4>Tier 3 â€¢ 20+</h4><p>Big boost</p></div>
        </div>
        <div class="divider"></div>
        <h3>Leaderboard (verified only)</h3>
        <div class="lb" id="leaderboard"><div class="mut">Loadingâ€¦</div></div>
      </div>

      <!-- HISTORY -->
      <div class="card" id="historyCard" style="margin-top:16px">
        <h3>Your History (last 30 days)</h3>
        <div id="historyWrap" class="mut">Loading...</div>
      </div>
    </div>
  </div>
</div>

<script>
/* ========================= CONFIG ========================= */
// IMPORTANT: paste your Web App deployment URL here
const ADMIN_WEBHOOK = 'https://script.google.com/macros/s/AKfycby88EZHRa7BCP-jJDzc3l7qKPTbFc1vsR5nUA-G0RteEycoP6nVQJpUtVpItvYUSIDSRQ/exec';

// Your 12 avatar URLs
const AVATARS = [
  'https://ricomx.ft-crm.com/media-api/serve/30739191-4079-40cd-9154-f15c869c9f35_1.png',
  'https://ricomx.ft-crm.com/media-api/serve/7e97b3d5-f53f-4211-b7d3-0c012a8e05ff_2.png',
  'https://ricomx.ft-crm.com/media-api/serve/4120e46c-d810-46bb-924d-fb7769b56c0c_3.png',
  'https://ricomx.ft-crm.com/media-api/serve/84bc31f3-69d6-47e9-950b-e557dd0cf4f6_4.png',
  'https://ricomx.ft-crm.com/media-api/serve/6959ee62-92fa-4192-a2d6-f678a4934b4f_8.png',
  'https://ricomx.ft-crm.com/media-api/serve/587f1afe-0e39-4f76-8715-48496452cfdf_7.png',
  'https://ricomx.ft-crm.com/media-api/serve/596c02c5-ad1c-42b7-9fb2-da6df154d35b_6.png',
  'https://ricomx.ft-crm.com/media-api/serve/d0692e25-3fdf-4004-af72-b572175fd49c_5.png',
  'https://ricomx.ft-crm.com/media-api/serve/1a77dbff-a836-4e7b-831f-77734198c725_16.png',
  'https://ricomx.ft-crm.com/media-api/serve/a698b757-2f99-49a7-95fb-68318d1637d6_18.png',
  'https://ricomx.ft-crm.com/media-api/serve/ab8c0632-b1d4-41e5-be64-ba1e96d5ab1b_19.png',
  'https://ricomx.ft-crm.com/media-api/serve/a450b16e-9310-4e83-ae66-ea71822a218b_9.png'
];

const CAMPAIGN = { startDay:1, lockDay:15, resetDay:16 }; // 1â€“14 earn, 15 VIP Day, 16+ locked

/* ==================== STORAGE / STATE ==================== */
const K_PROFILE='vip_profile_gate_v2';
const K_POINTS ='vip_points_gate_v2';
const K_GAME   ='vip_game_gate_v2';

const nowISO = ()=> new Date().toISOString();
const load = (k,d)=>{ try{return JSON.parse(localStorage.getItem(k)) ?? d;}catch(e){return d;} };
const save = (k,v)=> localStorage.setItem(k, JSON.stringify(v));

let profile = load(K_PROFILE, { username:'', avatar:AVATARS[0], createdAt:'', verifiedUser:false, verifiedAwarded:false });
let points  = load(K_POINTS,  { total:0, logs:[], lastGameDay:'', dailyGameCredit:0, lastCheckDay:'' });
let game    = load(K_GAME,    { best:0 });

/* ====================== DOM REFS ======================= */
const d = id => document.getElementById(id);
const gateMask = d('gateMask'), gateUsername = d('gateUsername'), gateEnterBtn = d('gateEnterBtn'), gateErr = d('gateErr');
const app = d('app'), topUsername = d('topUsername'), avatarImg = d('avatarImg'), verifyChip = d('verifyChip');
const m_verified = d('m_verified'), m_checkin = d('m_checkin'), m_game = d('m_game'), checkinBtn = d('checkinBtn');
const ptsTotal = d('ptsTotal'), fill = d('fill'), dailyCredit = d('dailyCredit');
const gameWrap = d('gameWrap'), gameC = d('game'), scoreTxt = d('scoreTxt'), bestTxt = d('bestTxt'), startBtn = d('startBtn'), backBtn = d('backBtn'), soundChk = d('soundChk');
const ctx = gameC.getContext('2d',{alpha:false});
const leaderboardEl = d('leaderboard');
const historyWrap = d('historyWrap');
const avatarMask = d('avatarMask'), avaGrid = d('avaGrid'), closeAvaBtn = d('closeAvaBtn'), profileChip = d('profileChip');
const syncChip = d('syncChip');

/* ===================== DATE HELPERS ===================== */
function ymd(d=new Date()){ return [d.getFullYear(), d.getMonth()+1, d.getDate()] }
function inEarnWindow(){ const [, , day] = ymd(); return day >= CAMPAIGN.startDay && day <= (CAMPAIGN.lockDay-1); }
function isVipDay(){ const [, , day] = ymd(); return day === CAMPAIGN.lockDay; }
function isLocked(){ const [, , day] = ymd(); return day >= CAMPAIGN.resetDay; }

/* =================== SERVER API HELPERS =================== */
function showSync(on){ syncChip.style.display = on ? 'block' : 'none'; if(on) syncChip.textContent='Syncingâ€¦'; else syncChip.textContent=''; }
async function apiGet(params){
  const url = new URL(ADMIN_WEBHOOK);
  Object.entries(params||{}).forEach(([k,v])=> url.searchParams.set(k,v));
  const res = await fetch(url.toString(), { cache:'no-store' });
  if(!res.ok) throw new Error('Network');
  return res.json();
}
async function checkUserAllowed(username){
  return apiGet({action:'checkUser', u: username});
}
async function fetchProfile(){
  return apiGet({action:'profile', u: profile.username});
}
async function fetchHistory(){
  return apiGet({action:'history', u: profile.username});
}
async function fetchLeaderboard(){
  try{
    const rows = await apiGet({action:'leaderboard'});
    if(!Array.isArray(rows) || !rows.length){ leaderboardEl.innerHTML='<div class="mut">No verified entries yet.</div>'; return; }
    const me = (profile.username||'').toLowerCase();
    const html = [
      '<table><thead><tr><th class="pos">#</th><th>Player</th><th>Points</th><th>Best</th></tr></thead><tbody>',
      ...rows.map((r,i)=>`<tr${String(r.username||'').toLowerCase()===me?' class="me"':''}><td class="pos">${i+1}</td><td>${r.username}</td><td>${r.points}</td><td>${r.best}</td></tr>`),
      '</tbody></table>'
    ].join('');
    leaderboardEl.innerHTML = html;
  }catch(e){ leaderboardEl.innerHTML='<div class="mut">Leaderboard unavailable.</div>'; }
}
async function postEvent({type, delta=0, meta={}, ymd, eventId}){
  if (!ADMIN_WEBHOOK || !profile.username) return {ok:false, error:'no_url_or_user'};
  showSync(true);
  try{
    const res = await fetch(ADMIN_WEBHOOK, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        username: profile.username,
        ymd: ymd || new Date().toISOString().slice(0,10),
        type, delta, meta,
        eventId: eventId || `${type}-${Date.now()}`
      })
    });
    const text = await res.text();
    try { return JSON.parse(text); }
    catch { return {ok:false, error:'non_json', preview: text.slice(0,160)}; }
  } catch (e) {
    return {ok:false, error:String(e)};
  } finally { showSync(false); }
}

/* =================== GATE: CHECK USER =================== */
function maskErr(msg){ gateErr.textContent = msg; gateErr.style.display='block'; }
function hideErr(){ gateErr.style.display='none'; }

async function enterWithUsername(){
  hideErr();
  const u = (gateUsername.value||'').trim();
  if(!u){ maskErr('Please enter your username.'); return; }
  try{
    verifyChip.textContent = 'Checkingâ€¦';
    const data = await checkUserAllowed(u);
    if(!data.allowed){
      verifyChip.textContent = 'Access denied';
      verifyChip.className = 'chip bad';
      maskErr('Username not on VIP Allowlist. Please contact support.');
      return;
    }

    // Allowed â†’ baseline profile
    profile.username = u;
    profile.createdAt = profile.createdAt || nowISO();
    if (data.avatar) profile.avatar = data.avatar;

    // Award the one-time "Verified +1" (server will dedupe if already given)
    try {
      const vr = await postEvent({ type:'verify', delta:1 });
      if (vr?.ok && typeof vr.lifetimePoints === 'number') {
        points.total = vr.lifetimePoints;
        save(K_POINTS, points);
      }
    } catch (e) {}

    // Pull authoritative profile (lifetime totals, verified flag, best, daily credit)
    const prof = await fetchProfile();
    if (prof) {
      profile.verifiedUser = !!prof.verified;
      if (prof.avatar) profile.avatar = prof.avatar;
      points.total = Number(prof.lifetimePoints||0);
      game.best = Number(prof.best||0);
      points.dailyGameCredit = Number(prof.dailyCredit||0);
      save(K_PROFILE, profile); save(K_POINTS, points); save(K_GAME, game);
    }

    refreshHeader(); updatePointsUI();
    gateMask.style.display='none'; app.style.display='block';

    fetchLeaderboard();
    fetchHistory().then(h=> renderHistory(h.days)).catch(()=> renderHistory([]));
  }catch(e){
    maskErr('Could not reach verification service. Try again.');
  }
}

gateEnterBtn.addEventListener('click', enterWithUsername);
gateUsername.addEventListener('keydown', e=>{ if(e.key==='Enter') enterWithUsername(); });

/* =================== HEADER / MISSIONS =================== */
function refreshHeader(){
  topUsername.textContent = profile.username || 'â€”';
  avatarImg.src = profile.avatar || (AVATARS[0]||'');
  if(profile.verifiedUser){ verifyChip.textContent='Verified'; verifyChip.className='chip ok'; m_verified.className='chip ok'; }
  else { verifyChip.textContent='Unverified'; verifyChip.className='chip bad'; m_verified.className='chip'; }
}
function updatePointsUI(){
  ptsTotal.textContent = points.total;
  const maxTier=20; fill.style.width = Math.min(100, (points.total/maxTier)*100) + '%';
  const today = new Date().toISOString().slice(0,10);
  if(points.lastGameDay !== today){ points.lastGameDay=today; points.dailyGameCredit=0; save(K_POINTS, points); }
  dailyCredit.textContent = `${points.dailyGameCredit}/3`;
}
function refreshMissionsUI(){
  if(isVipDay()){
    m_checkin.textContent = 'VIP Day â€” Missions locked';
    checkinBtn.disabled = true;
  } else if(isLocked()){
    m_checkin.textContent = 'Missions locked until next month';
    checkinBtn.disabled = true;
  } else {
    checkinBtn.disabled = (points.lastCheckDay === new Date().toISOString().slice(0,10) || !inEarnWindow());
    m_checkin.className = checkinBtn.disabled ? 'chip ok' : 'chip';
  }
  m_game.className = inEarnWindow() ? 'chip' : 'chip bad';
}

/* ======================== POINTS ======================== */
function setTotalFromServerIfHigher(serverTotal){
  if(typeof serverTotal !== 'number') return false;
  if(serverTotal > (points.total||0)){
    points.total = serverTotal; save(K_POINTS, points); updatePointsUI();
    return true;
  }
  return false;
}

/* ===================== DAILY CHECK-IN ==================== */
checkinBtn.addEventListener('click', async ()=>{
  if(!inEarnWindow()){ alert('Check-ins available only from 1â€“14.'); return; }
  const today = new Date().toISOString().slice(0,10);
  if(points.lastCheckDay === today){ alert('You already checked in today.'); return; }
  const r = await postEvent({type:'checkin', delta:1, ymd:today});
  if (r?.ok){
    points.lastCheckDay = today;
    if (typeof r.lifetimePoints === 'number') setTotalFromServerIfHigher(r.lifetimePoints);
    try{ const prof = await fetchProfile(); if (prof){ points.dailyGameCredit = Number(prof.dailyCredit||0); save(K_POINTS, points); updatePointsUI(); } }catch(e){}
    refreshMissionsUI();
    confettiBurst(gameWrap);
  } else {
    alert('Check-in failed: ' + (r?.error || 'unknown'));
  }
});

/* ========================= GAME ========================= */
let playing=false, frame=0, score=0, mult=1;
let paddle = { x: gameC.width/2, y: gameC.height-22, w:100, h:12 };
let drops=[], lastSpawn=0;
let audioCtx=null;

function playTone(freq, dur, type='sine', gain=0.06){
  if(!soundChk.checked) return;
  try{
    if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
    o.type=type; o.frequency.value=freq; g.gain.setValueAtTime(gain,audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+(dur/1000)); o.connect(g).connect(audioCtx.destination);
    o.start(); o.stop(audioCtx.currentTime+(dur/1000));
  }catch(e){}
}
function confettiBurst(container){
  const N=22;
  for(let i=0;i<N;i++){
    const s=document.createElement('div'); s.className='spark'; s.textContent='âœ¦';
    const rect = container.getBoundingClientRect();
    s.style.left=(rect.width/2)+'px'; s.style.top='20px';
    s.style.position='absolute';
    s.style.fontSize=(12+Math.random()*10)+'px'; s.style.color=`hsl(${Math.random()*360},90%,70%)`;
    container.appendChild(s);
    const angle=Math.random()*Math.PI*2; const dist=60+Math.random()*120;
    const dx=Math.cos(angle)*dist, dy=Math.sin(angle)*dist;
    s.animate([{transform:'translate(0,0)',opacity:1},{transform:`translate(${dx}px,${dy}px)`,opacity:0}],{duration:800+Math.random()*600,easing:'cubic-bezier(.2,.6,.2,1)'});
    setTimeout(()=>s.remove(),1400);
  }
}
function resetGame(){ score=0; mult=1; drops=[]; frame=0; scoreTxt.textContent=score; backBtn.disabled=true; }
function spawn(){
  const t=Math.random(); const type = t<0.70?'coin':(t<0.90?'bomb':'mult');
  const x = 20 + Math.random()*(gameC.width-40); const vy = 2 + Math.random()*3 + frame*0.0008;
  drops.push({x:x, y:-10, vy, type});
}
function draw(){
  const grd=ctx.createLinearGradient(0,0,0,gameC.height); grd.addColorStop(0,'#0e133a'); grd.addColorStop(1,'#0a0c24');
  ctx.fillStyle=grd; ctx.fillRect(0,0,gameC.width,gameC.height);
  ctx.fillStyle='#7f77ff'; ctx.fillRect(paddle.x-paddle.w/2, paddle.y, paddle.w, paddle.h);
  ctx.fillStyle='rgba(255,110,196,.25)'; ctx.fillRect(paddle.x-paddle.w/2, paddle.y+10, paddle.w, 2);
  for(let i=0;i<drops.length;i++){
    const d0=drops[i]; d0.y+=d0.vy; ctx.font='24px system-ui'; ctx.textBaseline='middle';
    if(d0.type==='coin'){ ctx.fillText('ðŸª™', d0.x-12, d0.y); }
    else if(d0.type==='bomb'){ ctx.fillText('ðŸ’£', d0.x-12, d0.y); if(d0.y>paddle.y-10 && d0.y<paddle.y+20 && Math.abs(d0.x-paddle.x)<(paddle.w/2)){ gameWrap.animate([{transform:'translate(0,0)'},{transform:'translate(-4px,0)'},{transform:'translate(4px,0)'},{transform:'translate(0,0)'}],{duration:180}); } }
    else { ctx.fillText('âœ¨', d0.x-12, d0.y); }
    if(d0.y>paddle.y-10 && d0.y<paddle.y+20 && Math.abs(d0.x-paddle.x)<(paddle.w/2)){
      if(d0.type==='coin'){ score += (1*mult); scoreTxt.textContent=score; playTone(920,80,'sine',0.07); }
      else if(d0.type==='bomb'){ score=Math.max(0,score-3); scoreTxt.textContent=score; playTone(160,140,'sawtooth',0.07); }
      else { mult=Math.min(4,mult+1); playTone(520,100,'triangle',0.07); }
      drops.splice(i,1); i--;
    } else if(d0.y>gameC.height+20){ drops.splice(i,1); i--; }
  }
  ctx.fillStyle='rgba(255,255,255,.7)'; ctx.font='12px system-ui'; ctx.fillText(`x${mult} multiplier`, 10, 18);
  if(playing){ frame++; if(frame-lastSpawn>24){ spawn(); lastSpawn=frame; } requestAnimationFrame(draw); }
  else { ctx.fillStyle='rgba(0,0,0,.35)'; ctx.fillRect(0,0,gameC.width,gameC.height); ctx.fillStyle='#c7cbff'; ctx.font='16px system-ui'; ctx.fillText('Press START to play', gameC.width/2-80, gameC.height/2); }
}
async function endGame(){
  playing=false; backBtn.disabled=false;
  if(score>game.best){
    game.best=score; save(K_GAME,game); bestTxt.textContent=game.best; confettiBurst(gameWrap);
    postEvent({type:'gameBest', delta:0, meta:{best:game.best}});
  }
  const today = new Date().toISOString().slice(0,10);
  if(points.lastGameDay !== today){ points.lastGameDay=today; points.dailyGameCredit=0; }
  let award=0; if(points.dailyGameCredit<3){ if(score>=100)award=3; else if(score>=50)award=2; else if(score>=20)award=1; }
  if(award>0){
    const r = await postEvent({type:'gameAward', delta:award, ymd:today});
    if (r?.ok){
      if (typeof r.lifetimePoints === 'number') setTotalFromServerIfHigher(r.lifetimePoints);
      try{ const prof = await fetchProfile(); if (prof){ points.dailyGameCredit = Number(prof.dailyCredit||0); save(K_POINTS, points); updatePointsUI(); } }catch(e){}
      alert(`Nice! You earned +${Math.min(award,3)} point(s) today.`);
    } else {
      alert('Game award failed: ' + (r?.error || 'unknown'));
    }
  }
  updatePointsUI(); draw();
}
startBtn.addEventListener('click', ()=>{
  if(!inEarnWindow()){ alert('Mini-game available 1â€“14 only.'); return; }
  playing=true; resetGame(); draw(); setTimeout(()=>{ if(playing) endGame(); }, 45000);
});
backBtn.addEventListener('click', ()=>{ playing=false; draw(); });
function setPaddle(evt){
  const r=gameC.getBoundingClientRect(); const cx=(evt.clientX ?? evt.touches?.[0]?.clientX ?? 0) - r.left; const scale = gameC.width / r.width;
  paddle.x = Math.max(50, Math.min(gameC.width-50, cx*scale));
}
gameC.addEventListener('mousemove', setPaddle);
gameC.addEventListener('touchstart', e=>{ setPaddle(e); e.preventDefault(); }, {passive:false});
gameC.addEventListener('touchmove',  e=>{ setPaddle(e); e.preventDefault(); }, {passive:false});

/* ===================== HISTORY (DailyLog UI) ===================== */
function renderHistory(days){
  if(!days || !days.length){ historyWrap.innerHTML = '<div class="mut">No history yet.</div>'; return; }
  const rows = [...days].slice(-30).reverse().map(d => {
    const items = (d.items||[]).map(it => {
      const sign = it.delta>0 ? '+' : '';
      return `<div>â€¢ ${sign}${it.delta} <span class="mut">â€” ${it.reason||'award'}</span></div>`;
    }).join('');
    const totSign = d.total>0?'+':'';
    return `<div style="padding:8px;border-bottom:1px solid #2a2e58">
              <div><b>${d.date}</b> â€” Total: ${totSign}${d.total}</div>
              <div class="mut" style="margin-top:4px">${items}</div>
            </div>`;
  }).join('');
  historyWrap.innerHTML = rows;
}

/* ===================== AVATAR PICKER ===================== */
function openAvatarPicker(){
  if(!avaGrid.dataset.ready){
    avaGrid.innerHTML = AVATARS.map((src,i)=>`<img src="${src}" alt="Avatar ${i+1}" data-idx="${i}">`).join('');
    avaGrid.dataset.ready = '1';
    avaGrid.addEventListener('click', async (e)=>{
      const el = e.target.closest('img[data-idx]'); if(!el) return;
      const idx = Number(el.dataset.idx)||0;
      profile.avatar = AVATARS[idx] || profile.avatar;
      save(K_PROFILE, profile); avatarImg.src = profile.avatar; confettiBurst(document.body);
      await postEvent({type:'avatar', delta:0, meta:{avatar: profile.avatar}});
    });
  }
  avatarMask.style.display='flex';
}
profileChip.addEventListener('click', openAvatarPicker);
closeAvaBtn.addEventListener('click', ()=> avatarMask.style.display='none');
avatarMask.addEventListener('click', (e)=>{ if(e.target===avatarMask) avatarMask.style.display='none'; });

/* ========================= BOOT ========================= */
function drawBoot(){ bestTxt.textContent = game.best; updatePointsUI(); refreshMissionsUI(); draw(); }
(function boot(){
  if(profile.username){ gateUsername.value = profile.username; }
  avatarImg.src = profile.avatar || (AVATARS[0]||'');
  drawBoot();
})();
</script>
</body>
</html>
