<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<meta name="color-scheme" content="dark" />
<title>VIP Day Hub — Rico.bet</title>
<style>
  :root{
    --bg0:#0a0c16; --bg1:#0e1030; --bg2:#0b0d24; --ink:#eef2ff; --mut:#a7b2d8; --edge:#ffffff14;
    --g1:#ff6ec4; --g2:#7873f5; --acc:#ffd86a; --ok:#aef7c1; --bad:#ffb3be; --mxw:560px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:
    radial-gradient(1200px 800px at 70% -10%, #17183e 0%, transparent 60%),
    linear-gradient(180deg,#0a0c16,#060713);
    color:var(--ink);font:15px/1.5 Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Arial,sans-serif;
    overflow-x:hidden;
  }
  .app{max-width:var(--mxw);margin:0 auto;min-height:100dvh;display:grid;grid-template-rows:auto 1fr}
  header{position:sticky;top:0;background:linear-gradient(180deg,#12143a,#0b0d24);border-bottom:1px solid var(--edge);padding:12px 14px;z-index:10}
  .hrow{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .brand{display:flex;align-items:center;gap:10px;font-weight:900}
  .brand .logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--g1),var(--g2));box-shadow:0 6px 16px rgba(120,115,245,.35)}
  .mut{color:var(--mut)}
  main{padding:14px 14px calc(120px + env(safe-area-inset-bottom,0))}
  .card{background:linear-gradient(180deg,#14163a,#10122f);border:1px solid var(--edge);border-radius:16px;padding:14px;margin-bottom:12px;box-shadow:0 18px 40px rgba(0,0,0,.25)}
  h1,h2,h3{margin:0 0 8px}
  h2{font-size:18px} h3{font-size:16px}
  p{margin:0 0 8px;color:#dfe5ff}
  .btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:900;cursor:pointer}
  .btnPrimary{background:var(--acc);color:#2a1a00;box-shadow:0 4px 0 rgba(0,0,0,.18)}
  .btnGhost{background:#ffffff1a;color:#fff;border:1px solid var(--edge)}
  .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .small{font-size:12px}
  .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--edge);border-radius:999px;padding:6px 10px;color:#cfd6ff}

  /* Tabs nav (bottom) */
  nav.iconnav{position:fixed;left:50%;transform:translateX(-50%);bottom:max(10px,env(safe-area-inset-bottom));width:min(var(--mxw),100% - 12px);display:grid;grid-template-columns:repeat(4,1fr);gap:8px;padding:10px 12px;background:rgba(14,16,43,.96);backdrop-filter:blur(6px);border:1px solid var(--edge);border-radius:16px;z-index:100}
  .iconnav .itab{appearance:none;border:0;background:transparent;color:#cfd6ff;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:6px;border-radius:14px;padding:8px 6px;font-weight:800}
  .iconnav .ico{width:26px;height:26px;fill:none;stroke:currentColor;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round;transition:transform .25s,color .25s}
  .iconnav .itab.active{color:#fff}
  .iconnav .itab.active .ico{transform:translateY(-2px) scale(1.06)}
  .inkbar{position:absolute;bottom:10px;height:44px;left:12px;right:12px;width:calc((100% - 24px - 8px*3)/4);border-radius:16px;background:radial-gradient(90% 140% at 10% 0%,#ff6ec4 0%,#7873f5 60%,#ffcabf 100%);box-shadow:0 12px 26px rgba(255,79,216,.35), inset 0 -2px 6px rgba(0,0,0,.18);transform:translateX(calc(var(--ix) * (100% + 8px)));transition:transform .28s cubic-bezier(.22,.9,.24,1)}

  /* Home view */
  .vipGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .vipBox{background:linear-gradient(180deg,#1a1d4b,#12153a);border:1px solid var(--edge);border-radius:14px;padding:12px}
  .vipBox b{font-size:18px}

  /* VIP Day lock */
  .lockCard{position:relative;padding:16px;border-radius:16px;background:linear-gradient(180deg,#16184a,#101232);border:1px solid var(--edge)}
  .count{font:700 20px/1 Inter;letter-spacing:.6px}
  .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:linear-gradient(90deg,var(--g1),var(--g2));color:#061018;font-weight:900}

  /* Check-in */
  .streak{display:flex;gap:6px;flex-wrap:wrap}
  .dot{width:28px;height:28px;border-radius:50%;display:grid;place-items:center;border:1px solid var(--edge);background:#0e1230;color:#9cb0ff;font-weight:900}
  .dot.hit{background:linear-gradient(180deg,#2bff9a,#12d18f);color:#052014;border-color:#0d924f}
  .spinWrap{display:grid;place-items:center;border:1px dashed var(--edge);border-radius:12px;padding:12px;margin-top:8px}

  /* Leaderboard */
  .lbPod{display:grid;grid-template-columns:1fr 1.2fr 1fr;gap:10px;align-items:end;margin-top:8px}
  .step{position:relative;border-radius:16px 16px 10px 10px;background:linear-gradient(180deg,#ffffff,#f0ecff);padding:10px 8px 12px;border:1px solid #00000010;box-shadow:inset 0 -12px 18px rgba(100,70,180,.10),0 8px 18px rgba(0,0,0,.10);display:grid;place-items:center;min-height:90px;color:#20184b}
  .s1{min-height:126px}.s2{min-height:104px}.s3{min-height:98px}
  .trophy{position:absolute;top:-12px;left:10px;width:34px;height:34px;border-radius:50%;display:grid;place-items:center;font-weight:900;border:2px solid rgba(0,0,0,.06);box-shadow:0 6px 14px rgba(0,0,0,.18)}
  .t1{background:radial-gradient(circle at 35% 30%,#fff,#ffcf5a 65%);color:#5a4300}
  .t2{background:radial-gradient(circle at 35% 30%,#fff,#dbe6ff 65%);color:#1d2945}
  .t3{background:radial-gradient(circle at 35% 30%,#fff,#ffd9b3 65%);color:#4a2c12}
  .av{position:absolute;top:-64px;left:50%;transform:translateX(-50%);width:76px;height:76px;border-radius:50%;border:4px solid #fff;box-shadow:0 10px 22px rgba(0,0,0,.25);background:#fff center/cover no-repeat}
  .name{margin-top:14px;font-weight:900}
  .list{display:grid;gap:8px;margin-top:10px}
  .rowli{display:grid;grid-template-columns:auto 1fr auto;gap:8px;align-items:center;background:linear-gradient(180deg,rgba(255,255,255,.95),rgba(255,255,255,.8));border:1px solid rgba(0,0,0,.06);border-radius:14px;padding:10px;color:#2b2350}
  .rk{display:grid;place-items:center;width:38px;height:38px;border-radius:12px;font-weight:900;background:#f0ecff;border:1px solid rgba(0,0,0,.06)}
  .face{width:38px;height:38px;border-radius:50%;background:#eee center/cover no-repeat;border:2px solid #fff;margin-right:8px}
  .uname{font-weight:800}
  .val{font-weight:900;color:#5b4bb4}
  .search{display:grid;grid-template-columns:1fr auto;gap:8px;margin-top:8px}
  .input{border-radius:12px;border:1px solid var(--edge);background:#0f1030;color:#eff3ff;padding:10px 12px}
  .go{appearance:none;border:0;border-radius:12px;padding:10px 12px;background:var(--acc);color:#3a2400;font-weight:900;cursor:pointer;box-shadow:0 4px 0 rgba(0,0,0,.12)}
  .result{margin-top:8px;background:rgba(255,255,255,.92);border:1px solid rgba(0,0,0,.08);color:#2b2350;border-radius:12px;padding:10px 12px;font-weight:700;display:none}

  /* Gate modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;place-items:center;z-index:2000}
  .modal.show{display:grid}
  .modalCard{width:min(var(--mxw),92vw);border-radius:16px;padding:16px;background:linear-gradient(180deg,#151744,#101232);border:1px solid rgba(255,255,255,.12);box-shadow:0 18px 38px rgba(0,0,0,.35);position:relative}
  .closeX{position:absolute;right:10px;top:10px;background:transparent;border:0;color:#cfd8ff;font-weight:900;font-size:18px;cursor:pointer}
  .inp{width:100%;border-radius:10px;border:1px solid var(--edge);background:#0f1030;color:#eff3ff;padding:10px 12px}

  /* Sticky sound button */
  .soundBtn{position:fixed;right:12px;bottom:calc(72px + env(safe-area-inset-bottom,0));background:rgba(255,255,255,.95);color:#111;border:1px solid rgba(0,0,0,.08);border-radius:14px;padding:10px 12px;display:none;gap:8px;align-items:center;font-weight:900;z-index:1100;box-shadow:0 10px 24px rgba(0,0,0,.25)}
  .soundBtn.show{display:inline-flex} .soundBtn.active{background:linear-gradient(90deg,#ffd86a,#ffc24d)}
  .soundBtn .ic{width:22px;height:22px;fill:none;stroke:currentColor;stroke-width:1.8}
</style>
</head>
<body>
  <div class="app">
    <header>
      <div class="hrow">
        <div class="brand"><div class="logo" aria-hidden="true"></div><div>VIP Day Hub</div></div>
        <div class="mut small" id="hdrRight">v1</div>
      </div>
    </header>
    <main id="view"></main>
  </div>

  <!-- Bottom Tabs -->
  <nav class="iconnav" aria-label="Primary">
    <div class="inkbar" aria-hidden="true"></div>
    <button class="itab active" data-tab="home" data-idx="0" aria-label="Home">
      <svg class="ico" viewBox="0 0 24 24"><path d="M4 10.5l8-6 8 6V20a2 2 0 0 1-2 2h-3.5a1.5 1.5 0 0 1-1.5-1.5V16a2 2 0 0 0-2-2 2 2 0 0 0-2 2v4.5A1.5 1.5 0 0 1 7.5 22H4a2 2 0 0 1-2-2v-9.5z"/></svg><span>Home</span>
    </button>
    <button class="itab" data-tab="vipday" data-idx="1" aria-label="VIP Day Game">
      <svg class="ico" viewBox="0 0 24 24"><path d="M12 2l3 6 6 .9-4.5 4.4 1 6.3L12 17l-5.5 2.6 1-6.3L3 8.9 9 8z"/></svg><span>VIP Day</span>
    </button>
    <button class="itab" data-tab="checkin" data-idx="2" aria-label="Check-in">
      <svg class="ico" viewBox="0 0 24 24"><path d="M4 4h16v4H4zM4 10h10v4H4zM4 16h16v4H4z"/></svg><span>Check‑in</span>
    </button>
    <button class="itab" data-tab="leaderboard" data-idx="3" aria-label="Leaderboard">
      <svg class="ico" viewBox="0 0 24 24"><path d="M7 22V11a2 2 0 0 1 2-2h6v13H7zM3 22v-7a2 2 0 0 1 2-2h1v9H3zM17 22V5a2 2 0 0 1 2-2h2v19h-4z"/></svg><span>Leaders</span>
    </button>
  </nav>

  <!-- Login Gate -->
  <div id="gate" class="modal" role="dialog" aria-modal="true" aria-labelledby="gateTitle">
    <div class="modalCard">
      <button id="gateClose" class="closeX" aria-label="Close">✕</button>
      <h3 id="gateTitle">Login required</h3>
      <p class="mut">Start our Telegram mini-app and submit your <b>ricobet_username</b>, then tap <b>PLAY NOW</b> in the bot to return.</p>
      <div class="row" style="margin-top:8px">
        <a id="startBot" class="btn btnPrimary" href="https://t.me/ricobet_minigamebot?start=play" target="_blank" rel="noopener">Start Bot</a>
        <span class="mut small">or use fallback:</span>
      </div>
      <div class="row" style="margin-top:8px">
        <input id="ricoInput" class="inp" placeholder="ricobet_username"/>
        <button id="btnBind" class="btn btnPrimary">Unlock</button>
      </div>
    </div>
  </div>

  <!-- Theme music (optional) -->
  <audio id="bgm" src="theme.mp3" preload="auto" loop playsinline></audio>
  <button id="soundBtn" class="soundBtn" aria-label="Toggle sound" title="Sound">
    <svg viewBox="0 0 24 24" class="ic"><path d="M4 10h4l5-4v12l-5-4H4zM17 8a5 5 0 010 8"/></svg><span>Sound</span>
  </button>

<script>
/* ===================== CONFIG (EDIT THESE) ===================== */
const GAS_URL = "https://script.google.com/macros/s/AKfycbwJJEYwLfmyZ0A87hUCEHbRI7xBWNrsZdmfCjm5VDdShP9xFlj8KGHD5D-vZu_b2EVQ1w/exec"; // ← your Apps Script Web App
const RANK_SHEET_ID = "1rJg4RYn0AkvsqhVGk5CwhZrYNz0gFC6_7ZPiDXigU"; // ← Google Sheet ID for leaderboard
const RANK_SHEET_GID = "0"; // ← GID of the tab
const VIP_DAY_OF_MONTH = 15; // monthly on the 15th
const TIMEZONE = Intl.DateTimeFormat().resolvedOptions().timeZone || 'Asia/Kuala_Lumpur';
/* =============================================================== */

/* ===== tiny helpers ===== */
const $=(s,el)=> (el||document).querySelector(s);
const $all=(s,el)=> Array.from((el||document).querySelectorAll(s));
const esc=s=>String(s??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
const fmt=n=>{n=Number(n||0);return n>=1000?(Math.round(n/100)/10).toLocaleString()+"K":n.toLocaleString()};
const faceBg=url=>`url("${url}")`;
const qs = new URLSearchParams(location.search);

/* ===== auth helpers ===== */
const isLinked=()=> !!localStorage.getItem('auth_token');
function openGate(){ $('#gate').classList.add('show'); }
function closeGate(){ $('#gate').classList.remove('show'); }

async function manualUnlock(username){
  try{
    const r=await fetch(GAS_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({
      kind:'telegram',ricobet_username:username,data:{id: localStorage.getItem('tg_id')||('guest-'+crypto.randomUUID()), username: localStorage.getItem('tg_username')||''}
    })});
    const j=await r.json();
    if(j.ok && j.token){
      localStorage.setItem('auth_token', j.token);
      localStorage.setItem('player_name', j.user?.ricoUsername || j.user?.username || username || 'player');
      closeGate();
      render();
    }else alert('Unlock failed');
  }catch(e){ alert('Unlock failed: '+e.message); }
}

document.addEventListener('click',e=>{
  if(e.target.id==='gateClose') closeGate();
  if(e.target.id==='btnBind'){
    const v=($('#ricoInput').value||'').trim();
    if(!v){ alert('Please enter ricobet_username'); return; }
    manualUnlock(v);
  }
});

/* Handle deep-link return: ?token=... (SendPulse PLAY NOW) */
(async function bootAuthFromToken(){
  const token = qs.get('token');
  if(token){
    localStorage.setItem('auth_token', token);
    try{
      const r = await fetch(GAS_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({kind:'whoami',token})});
      const j = await r.json();
      if(j.ok && j.user){
        localStorage.setItem('player_provider','telegram');
        localStorage.setItem('player_provider_id', String(j.user.telegram_id||''));
        localStorage.setItem('player_name', j.user.rico_username || j.user.telegram_username || 'player');
        localStorage.setItem('tg_id', String(j.user.telegram_id||''));
        localStorage.setItem('tg_username', j.user.telegram_username||'');
      }
    }catch(e){}
  }
})();

/* ===== sticky sound (optional) ===== */
(function(){
  const audio=$('#bgm'), btn=$('#soundBtn'); if(!audio||!btn) return;
  const saved=localStorage.getItem('bgm_pref'); if(saved==='off'){audio.muted=true} if(saved==='on'){audio.muted=false}
  document.addEventListener('DOMContentLoaded',tryPlay,{once:true});
  async function tryPlay(){try{
    if(localStorage.getItem('bgm_pref')==='off'){btn.classList.add('show');return}
    audio.muted=false; await audio.play(); btn.classList.remove('show'); localStorage.setItem('bgm_pref','on')
  }catch(e){
    btn.classList.add('show');
    ['pointerdown','keydown','touchstart'].forEach(evt=>document.addEventListener(evt,unlock,{once:true}))
  }}
  async function unlock(){try{audio.muted=false;await audio.play();btn.classList.remove('show');btn.classList.add('active');localStorage.setItem('bgm_pref','on')}catch{}}
  btn.addEventListener('click',async()=>{try{
    if(audio.paused){audio.muted=false;await audio.play()}
    else {audio.muted=!audio.muted;if(audio.muted)await audio.pause();else await audio.play()}
    const on=!audio.paused && !audio.muted; btn.classList.toggle('active',on); if(on) btn.classList.remove('show'); localStorage.setItem('bgm_pref',on?'on':'off')
  }catch{}})
})();

/* ===== global state + router ===== */
let state={tab:'home'};
function moveInk(ix){ document.querySelector('nav.iconnav').style.setProperty('--ix', ix); }
$all('nav.iconnav .itab').forEach(btn=>{
  btn.addEventListener('click',()=>{
    state.tab=btn.dataset.tab;
    if((state.tab==='vipday' || state.tab==='checkin' || state.tab==='leaderboard') && !isLinked()){
      openGate();
    } else closeGate();
    render();
  })
});

function setHeader(){
  const t = state.tab==='vipday' ? 'VIP Day' : state.tab==='checkin' ? 'Daily Check‑in' : state.tab==='leaderboard' ? 'Leaderboard' : 'VIP Day Hub';
  $('#hdrRight').textContent = new Date().toLocaleDateString(undefined,{weekday:'short', day:'2-digit', month:'short'});
  document.querySelectorAll('.itab').forEach(b=>b.classList.toggle('active',b.dataset.tab===state.tab));
  moveInk(parseInt(document.querySelector('.itab.active')?.dataset.idx||'0',10));
}

function render(){
  setHeader();
  if(state.tab==='vipday') return renderVIPDay();
  if(state.tab==='checkin') return renderCheckin();
  if(state.tab==='leaderboard') return renderLeaderboard();
  renderHome();
}

/* ===================== VIEWS ===================== */
function renderHome(){
  const who = esc(localStorage.getItem('player_name')||'Guest');
  $('#view').innerHTML = `
    <div class="card">
      <h2>Welcome${isLinked()?`, ${who}`:''}</h2>
      <p>This hub runs <b>every month</b>. Check in daily to build your streak and unlock better rewards on <span class="badge">VIP Day (${VIP_DAY_OF_MONTH})</span>.</p>
      <div class="grid2" style="margin-top:8px">
        <div class="vipBox"><b>VIP Day</b><p class="small">Mini game unlocks on day <b>${VIP_DAY_OF_MONTH}</b> (local time: ${esc(TIMEZONE)}).</p></div>
        <div class="vipBox"><b>Check‑in</b><p class="small">Tap once per day. Earn points and improve your VIP Day tier.</p></div>
      </div>
    </div>
    <div class="card">
      <h3>Quick Links</h3>
      <div class="row" style="margin-top:8px">
        <button class="btn btnPrimary" onclick="document.querySelector('[data-tab=vipday]').click()">Go to VIP Day</button>
        <button class="btn btnGhost" onclick="document.querySelector('[data-tab=checkin]').click()">Daily Check‑in</button>
      </div>
      <div class="row" style="margin-top:8px">
        ${isLinked()?`<span class="pill">Linked as <b>${who}</b></span>`:`<button class="btn btnGhost" onclick="openGate()">Link Telegram</button>`}
      </div>
    </div>
    <div class="card">
      <details>
        <summary>Rules & FAQ</summary>
        <details open><summary>When is VIP Day?</summary><p>The <b>${VIP_DAY_OF_MONTH}th of every month</b> (local time).</p></details>
        <details><summary>How do I rank?</summary><p>Play the daily mini game after check‑in to earn points. Top 3 of the 7‑day window get extra rewards.</p></details>
        <details><summary>How are points used?</summary><p>Your monthly total sets your <b>VIP Day tier</b>; top scores win leaderboard prizes.</p></details>
        <details><summary>Anti‑fraud</summary><p>Duplicates, automation, or unfair play may be voided and lead to disqualification.</p></details>
      </details>
    </div>`;
}

/* ===== VIP Day view (locked until 15th) ===== */
function nextVIPDay(now){
  const y=now.getFullYear(), m=now.getMonth();
  let target = new Date(y, m, VIP_DAY_OF_MONTH, 0,0,0);
  if(now > target) target = new Date(y, m+1, VIP_DAY_OF_MONTH, 0,0,0);
  return target;
}

function renderVIPDay(){
  const now = new Date();
  const todayIsVIP = now.getDate()===VIP_DAY_OF_MONTH;
  const target = nextVIPDay(now);
  const ms = target - now; // if today is VIP Day, next is next month; but we want unlocked view if date==15

  if(!todayIsVIP){
    const remain = formatDuration(ms);
    $('#view').innerHTML = `
      <div class="card lockCard">
        <div class="row" style="justify-content:space-between">
          <h2>VIP Day Mini Game</h2>
          <span class="badge">Locked</span>
        </div>
        <p class="mut">Unlocks on the <b>${VIP_DAY_OF_MONTH}th</b> each month. Countdown:</p>
        <div class="count" id="vipCountdown">${remain}</div>
        <div class="row" style="margin-top:10px">
          <button class="btn btnGhost" onclick="document.querySelector('[data-tab=checkin]').click()">Build your streak</button>
        </div>
      </div>`;
    startCountdown(target, '#vipCountdown');
    return;
  }

  // Unlocked: show mini-game (simple Plinko with one session awarding points)
  $('#view').innerHTML = `
    <div class="card"><h2>VIP Day Mini Game</h2><p class="mut">Drop 3 balls. Your total becomes your VIP Day bonus points.</p></div>
    <div class="card">
      <div class="row" style="justify-content:space-between"><div><b>Lucky Drop — VIP</b></div><div class="pill" id="vpRuns">Runs left: 3</div></div>
      <canvas id="vipCanvas" width="520" height="340" style="width:100%;height:340px;margin-top:8px;background:linear-gradient(180deg,#0a0e24,#060814);border-radius:12px"></canvas>
      <div class="row" style="margin-top:8px"><button class="btn btnPrimary" id="vpDrop">Drop Ball</button><span class="mut small">Tap inside the board to drop at a position.</span></div>
      <div class="row" style="margin-top:8px"><span class="pill">Session score: <b id="vpScore">0</b></span></div>
    </div>`;
  runVIPPlinko();
}

function formatDuration(ms){
  if(ms<=0) return '00d 00h 00m 00s';
  const s=Math.floor(ms/1000), d=Math.floor(s/86400), h=Math.floor((s%86400)/3600), m=Math.floor((s%3600)/60), ss=s%60;
  return `${String(d).padStart(2,'0')}d ${String(h).padStart(2,'0')}h ${String(m).padStart(2,'0')}m ${String(ss).padStart(2,'0')}s`;
}

let countdownRAF=null;
function startCountdown(target, sel){
  const el = $(sel); if(!el) return;
  function tick(){ const ms = target - new Date(); el.textContent = formatDuration(ms); countdownRAF=requestAnimationFrame(tick);} tick();
}

function runVIPPlinko(){
  const canvas=$('#vipCanvas'), ctx=canvas.getContext('2d');
  const w=canvas.width=canvas.clientWidth, h=canvas.height=340;
  const pins=[], cols=9, rows=7, spacing=w/(cols+1), offsetY=70;
  for(let r=0;r<rows;r++){for(let c=0;c<cols;c++){const x=spacing*(c+1)+(r%2?spacing/2:0),y=offsetY+r*38;if(x>20&&x<w-20)pins.push({x,y})}}
  const slotVals=[10,15,20,40,100,40,20,15,10];
  let ball=null, total=0, runs=Number(localStorage.getItem('vip_runs_left')||'3');
  $('#vpRuns').textContent = `Runs left: ${runs}`;
  function drop(x){ if(runs<=0 || ball) return; ball={x:x||w/2,y:30,vx:0,vy:0,r:8}; runs--; localStorage.setItem('vip_runs_left', String(runs)); $('#vpRuns').textContent = `Runs left: ${runs}`; }
  $('#vpDrop').onclick=()=>drop();
  canvas.onclick=e=>{const rect=canvas.getBoundingClientRect();drop(e.clientX-rect.left)};

  function drawSlots(){for(let s=0;s<cols;s++){const sx=spacing*(s+1);ctx.fillStyle='#11245a';ctx.fillRect(sx-2,h-60,4,60);ctx.fillStyle='#bcd2ff';ctx.font='bold 12px Inter';ctx.textAlign='center';ctx.fillText(slotVals[s],sx,h-66)}}

  function loop(){ ctx.clearRect(0,0,w,h); ctx.fillStyle='#060b1a'; ctx.fillRect(0,0,w,h); drawSlots();
    ctx.fillStyle='#8aa3ff'; pins.forEach(p=>{ctx.beginPath();ctx.arc(p.x,p.y,4,0,Math.PI*2);ctx.fill()});
    if(ball){ ball.vy+=0.35; ball.x+=ball.vx; ball.y+=ball.vy; if(ball.x<ball.r){ball.x=ball.r;ball.vx*=-0.6} if(ball.x>w-ball.r){ball.x=w-ball.r;ball.vx*=-0.6}
      pins.forEach(p=>{const dx=ball.x-p.x,dy=ball.y-p.y,d=Math.hypot(dx,dy); if(d<ball.r+5){ const ang=Math.atan2(dy,dx),speed=Math.hypot(ball.vx,ball.vy)*0.9+1,dir=(Math.random()<0.5?-1:1)*0.9; ball.vx=Math.cos(ang)*speed*dir; ball.vy=Math.sin(ang)*speed; const ov=ball.r+5-d; ball.x+=Math.cos(ang)*ov; ball.y+=Math.sin(ang)*ov;}});
      if(ball.y>h-12){ ball.vy*=-0.35; ball.y=h-12; ball.vx*=0.95; if(Math.abs(ball.vy)<0.5){ let idx=Math.max(0,Math.min(cols-1,Math.round(ball.x/spacing)-1)); const award=slotVals[idx]||0; total+=award; $('#vpScore').textContent= String(total); reportScore({game:'vipday',points:award,week:currentMonthKey()}); ball=null; if(runs<=0){ $('#vpDrop').disabled=true; } } }
      ctx.fillStyle='#ffd86a'; ctx.beginPath(); ctx.arc(ball.x,ball.y,ball.r,0,Math.PI*2); ctx.fill();
    }
    requestAnimationFrame(loop);
  }
  loop();
}

function currentMonthKey(){ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }

/* ===== Check‑in (once per day + tiny daily spin) ===== */
function renderCheckin(){
  const todayKey = new Date().toISOString().slice(0,10);
  const last = localStorage.getItem('checkin_last')||'';
  const can = last!==todayKey;
  const streak = Number(localStorage.getItem('checkin_streak')||'0');
  const monthKey = currentMonthKey();

  $('#view').innerHTML = `
    <div class="card"><h2>Daily Check‑in</h2><p class="mut">Tap once per day to build your streak. You also get a tiny spin for bonus points.</p></div>
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="pill">Month <b>${monthKey}</b></div>
        <div class="pill">Streak: <b id="streakVal">${streak}</b></div>
      </div>
      <div class="streak" style="margin-top:10px" id="streakDots"></div>
      <div class="row" style="margin-top:10px">
        <button class="btn btnPrimary" id="btnCheckin" ${can? '':'disabled'}>${can? 'Check‑in Now':'Already checked in today'}</button>
        <span class="mut small">Local time: ${esc(TIMEZONE)}</span>
      </div>
      <div class="spinWrap">
        <div id="spinMsg" class="mut small">Do a quick spin after check‑in.</div>
        <div class="row" style="margin-top:6px"><button class="btn btnGhost" id="btnSpin" disabled>Spin</button><span class="mut small">Awards 1–10 pts once per day.</span></div>
        <div class="row" style="margin-top:6px"><span class="pill">Today bonus: <b id="spinVal">0</b></span></div>
      </div>
    </div>`;

  // build streak dots for current month (1..VIP_DAY_OF_MONTH or 1..30)
  const daysInMonth = new Date(new Date().getFullYear(), new Date().getMonth()+1, 0).getDate();
  const wrap = $('#streakDots'); wrap.innerHTML='';
  for(let i=1;i<=Math.min(daysInMonth, VIP_DAY_OF_MONTH);i++){
    const hit = localStorage.getItem('checkin_'+String(i).padStart(2,'0'))==='1';
    const d = document.createElement('div'); d.className='dot'+(hit?' hit':''); d.textContent = i; wrap.appendChild(d);
  }

  $('#btnCheckin').onclick = async ()=>{
    const now = new Date(); const day = now.getDate();
    if(localStorage.getItem('checkin_last')===todayKey) return;
    localStorage.setItem('checkin_last', todayKey);
    localStorage.setItem('checkin_'+String(day).padStart(2,'0'),'1');
    const newStreak = (Number(localStorage.getItem('checkin_streak')||'0')||0) + 1;
    localStorage.setItem('checkin_streak', String(newStreak));
    $('#streakVal').textContent = String(newStreak);
    $('#btnCheckin').disabled = true; $('#btnCheckin').textContent='Checked in!';
    // Notify GAS
    await reportScore({game:'checkin',points:1,week:monthKey});
    // unlock spin
    $('#btnSpin').disabled=false; $('#spinMsg').textContent='Spin is ready!';
    // update dots UI
    const idx = Math.min(day, VIP_DAY_OF_MONTH)-1; const dEl = wrap.children[idx]; if(dEl) dEl.classList.add('hit');
  };

  $('#btnSpin').onclick = async ()=>{
    if($('#btnSpin').disabled) return;
    $('#btnSpin').disabled = true;
    // random 1..10
    const award = 1 + Math.floor(Math.random()*10);
    $('#spinVal').textContent = String(award);
    await reportScore({game:'daily_spin',points:award,week:monthKey});
    $('#spinMsg').textContent='Bonus added!';
  };
}

/* ===== Leaderboard (7‑day window view + search) ===== */
const RANK_AVATARS=[
  "https://ricomx.ft-crm.com/media-api/serve/30739191-4079-40cd-9154-f15c869c9f35_1.png",
  "https://ricomx.ft-crm.com/media-api/serve/7e97b3d5-f53f-4211-b7d3-0c012a8e05ff_2.png",
  "https://ricomx.ft-crm.com/media-api/serve/4120e46c-d810-46bb-924d-fb7769b56c0c_3.png",
  "https://ricomx.ft-crm.com/media-api/serve/84bc31f3-69d6-47e9-950b-e557dd0cf4f6_4.png",
  "https://ricomx.ft-crm.com/media-api/serve/d0692e25-3fdf-4004-af72-b572175fd49c_5.png",
  "https://ricomx.ft-crm.com/media-api/serve/596c02c5-ad1c-42b7-9fb2-da6df154d35b_6.png",
  "https://ricomx.ft-crm.com/media-api/serve/587f1afe-0e39-4f76-8715-48496452cfdf_7.png",
  "https://ricomx.ft-crm.com/media-api/serve/6959ee62-92fa-4192-a2d6-f678a4934b4f_8.png",
  "https://ricomx.ft-crm.com/media-api/serve/a450b16e-9310-4e83-ae66-ea71822a218b_9.png",
  "https://ricomx.ft-crm.com/media-api/serve/24e07c3f-99fb-4bed-91f1-b91f1e0f7c8d_10.png",
  "https://ricomx.ft-crm.com/media-api/serve/120d451f-a6dc-4f7b-b3f4-a1b5b8642443_11.png",
  "https://ricomx.ft-crm.com/media-api/serve/65646abf-45f0-46b4-9c9c-f135f3b429e4_12.png",
  "https://ricomx.ft-crm.com/media-api/serve/685901d2-f392-4d9f-83bf-b8f5ae4cf3bc_13.png",
  "https://ricomx.ft-crm.com/media-api/serve/a3e8f9f5-851f-4048-b1ff-e7255de54266_14.png",
  "https://ricomx.ft-crm.com/media-api/serve/92cde2cb-1afa-4c2e-b0f7-bf77f6b37a4a_15.png",
  "https://ricomx.ft-crm.com/media-api/serve/1a77dbff-a836-4e7b-831f-77734198c725_16.png",
  "https://ricomx.ft-crm.com/media-api/serve/ab17bec9-169e-4e99-9e2d-e560fd29403e_17.png",
  "https://ricomx.ft-crm.com/media-api/serve/a698b757-2f99-49a7-95fb-68318d1637d6_18.png",
  "https://ricomx.ft-crm.com/media-api/serve/ab8c0632-b1d4-41e5-be64-ba1e96d5ab1b_19.png",
  "https://ricomx.ft-crm.com/media-api/serve/7c6d505e-174d-4214-9e93-bb7cdcc4098f_20.png",
];

async function fetchGViz(){
  const url=`https://docs.google.com/spreadsheets/d/${RANK_SHEET_ID}/gviz/tq?tqx=out:json&gid=${encodeURIComponent(RANK_SHEET_GID)}`;
  const text=await fetch(url,{cache:"no-store"}).then(r=>r.text());
  const j=(text.match(/google\.visualization\.Query\.setResponse\((.*)\);?/s)||[])[1]; if(!j) throw new Error('parse');
  const data=JSON.parse(j);
  const headers=data.table.cols.map(c=>c.label||c.id||"");
  const rows=data.table.rows.filter(r=>r&&r.c).map(r=> r.c.map(c=> c?(c.f!=null?c.f:c.v):""));
  return {headers,rows};
}
function pickIndex(headers,aliases){const L=headers.map(h=>String(h||'').toLowerCase());for(const a of aliases){const j=L.findIndex(h=>h.includes(a));if(j>-1)return j}return -1}
function normalize({headers:h,rows}){
  const ui=pickIndex(h,["username","user","player","name"]);
  const pi=pickIndex(h,["points","score","total"]);
  const di=pickIndex(h,["date","day","created","timestamp"]);
  if(ui<0||pi<0) throw new Error('missing cols');
  return rows.map(r=>({username:String(r[ui]||"").trim(),points:Number(String(r[pi]).replace(/[^\d.\-]/g,''))||0,date: di>-1? String(r[di]||"").trim() : ""})).filter(x=>x.username);
}
function last7DaysKey(){ const now=new Date(); const from = new Date(now.getTime()-6*86400000); return [from.toISOString().slice(0,10), now.toISOString().slice(0,10)]; }
const maskName = s => { s=String(s||''); if(s.length<=2) return s.replace(/.(?=.)/g,'*'); const a=s[0], b=s[s.length-1]; const middle = s.slice(1,-1).replace(/./g,'*'); return a+middle+b; };

async function renderLeaderboard(){
  $('#view').innerHTML = `
    <div class="card"><h2>7‑Day Leaderboard</h2><p class="mut">Extra rewards for Top 3 this window.</p></div>
    <div class="card" id="lbCard">
      <div class="lbPod">
        <div class="step s2"><div class="trophy t2">2</div><div class="av" id="p2a"></div><div class="name" id="p2n">—</div><div class="mut small" id="p2s"></div></div>
        <div class="step s1"><div class="trophy t1">1</div><div class="av" id="p1a"></div><div class="name" id="p1n">—</div><div class="mut small" id="p1s"></div></div>
        <div class="step s3"><div class="trophy t3">3</div><div class="av" id="p3a"></div><div class="name" id="p3n">—</div><div class="mut small" id="p3s"></div></div>
      </div>
      <div class="list" id="lbList"></div>
      <div class="search"><input id="lbQ" class="input" placeholder="Search username (Top 100)…"/><button id="lbFind" class="go">Find</button></div>
      <div id="lbMine" class="result"></div>
    </div>`;
  try{
    const raw = await fetchGViz();
    let items = normalize(raw);
    // Filter by last 7 days if date exists
    const [from,to] = last7DaysKey();
    items = items.filter(r=>!r.date || (r.date>=from && r.date<=to));
    items.sort((a,b)=> b.points-a.points); items.forEach((x,i)=>x.rank=i+1);
    const setPod=(id,row)=>{ const url=row?rankAvatar(row.rank):RANK_AVATARS[0];
      $(`#p${id}a`).style.backgroundImage=faceBg(url);
      $(`#p${id}n`).textContent=row?maskName(row.username):'—';
      $(`#p${id}s`).textContent=row?(fmt(row.points)+' pts'):'' }
    setPod(1,items[0]||null); setPod(2,items[1]||null); setPod(3,items[2]||null);
    const list=$('#lbList'); list.innerHTML='';
    items.slice(3,20).forEach(r=> list.insertAdjacentHTML('beforeend',
      `<div class="rowli"><div class="rk">${r.rank}</div><div class="row" style="gap:8px"><div class="face" style="background-image:${faceBg(rankAvatar(r.rank))}"></div><div class="uname">${esc(maskName(r.username))}</div></div><div class="val">${fmt(r.points)}</div></div>`));
    const TOP100 = items.slice(0,100);
    $('#lbFind').onclick=()=>{ const q=($('#lbQ').value||'').trim().toLowerCase(); const res=$('#lbMine'); if(!q){res.style.display='block'; res.textContent='Enter username'; return} const hit=TOP100.find(x=>x.username.toLowerCase()===q); res.style.display='block'; if(!hit){res.textContent='No match in Top 100 (7‑day window).'; return} res.innerHTML=`<b>${esc(hit.username)}</b> — Rank <b>${hit.rank}</b> • ${fmt(hit.points)} pts`; };
  }catch(e){
    $('#lbCard').insertAdjacentHTML('beforeend', `<p class="mut small">Could not load sheet. Check RANK_SHEET_ID/GID.</p>`);
  }
}
function rankAvatar(r){const i=Math.min(Math.max(1,r),20)-1;return RANK_AVATARS[i]}

/* ===== score reporting to GAS ===== */
async function reportScore({game,points,week=""}){
  const token=localStorage.getItem('auth_token')||''; if(!token){ console.warn('[score] missing token'); return; }
  try{
    const r=await fetch(GAS_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({kind:'score',token,game,points,week})});
    const j=await r.json().catch(()=> ({})); if(!j.ok){ console.warn('[score] rejected', j); }
  }catch(e){ console.warn('[score] network error', e); }
}

/* ===== boot UI ===== */
render(); moveInk(0);

</script>
</body>
</html>
